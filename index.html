<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PlayerHoods Match Scheduler</title>

<style>
:root{
  --bd:#ddd; --muted:#555; --danger:#b00020; --ok:#0b6b0b;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  margin:24px; color:#111;
}
h1{ margin:0 0 14px; font-size:20px; }

.card{ border:1px solid var(--bd); border-radius:12px; padding:14px; }
.sectionTitle{ font-weight:900; margin:0 0 8px; }
.sectionTitle.big{ font-size:18px; }

.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
label{ font-weight:800; margin:10px 0 6px; display:block; }

input[type="text"], input[type="date"], select{
  padding:10px; font-size:14px; border:1px solid #ccc;
  border-radius:10px; width:100%; box-sizing:border-box;
}
.row > input, .row > select{ flex:1; min-width:220px; }

button{
  padding:10px 14px; font-size:14px;
  border-radius:10px; cursor:pointer;
}
button.primary{ background:#111; color:#fff; border:1px solid #111; }
button.secondary{ background:#fff; border:1px solid #ccc; }
button:disabled{ opacity:.5; cursor:not-allowed; }

.layout{
  display:grid; grid-template-columns:1.3fr .7fr;
  gap:16px; margin-top:16px;
}
@media(max-width:980px){ .layout{ grid-template-columns:1fr; } }

.topPanel{
  display:grid; grid-template-columns:.8fr 1.2fr;
  gap:16px;
}
@media(max-width:980px){ .topPanel{ grid-template-columns:1fr; } }

.courtsCard{
  border:2px solid #111; border-radius:12px; padding:14px;
}

/* Smaller font for selection area (Courts/Roster lists) */
.selectionArea{ font-size:13px; color:#222; }

.list{
  border:1px solid #eee; border-radius:10px;
  padding:10px; max-height:360px; overflow:auto;
}
.item{
  display:flex; justify-content:space-between;
  padding:6px 4px; border-bottom:1px dashed #eee;
}
.item:last-child{ border-bottom:none; }
.checkboxRow{ display:flex; gap:10px; align-items:center; }
.checkboxRow input{ transform:scale(1.05); }

.small{ font-size:13px; color:var(--muted); }
.ok{ color:var(--ok); font-weight:800; }
.warn{ color:var(--danger); font-weight:800; }

.pairItem{ display:flex; gap:10px; margin:6px 0; align-items:center; }

table{ width:100%; border-collapse:collapse; margin-top:10px; }
th,td{ border:1px solid var(--bd); padding:8px; }
th{ background:#f6f6f6; }

/* Bigger font for generated results */
.resultWrap{ font-size:16px; color:#111; }
.resultHeader{
  font-size:20px; font-weight:900; margin-bottom:10px;
}
.subHeader{
  font-size:15px; margin-bottom:8px; color:#222;
}
</style>
</head>

<body>
<h1>playerhoods Match Scheduler</h1>

<!-- Date / Time -->
<div class="card">
  <div class="row">
    <div style="flex:1">
      <label>Date</label>
      <input id="sessionDate" type="date">
    </div>
    <div style="flex:1">
      <label>Time</label>
      <select id="sessionTime"></select>
    </div>
  </div>
</div>

<div class="layout">
  <!-- LEFT -->
  <div class="card">
    <div class="topPanel selectionArea">
      <!-- Courts -->
      <div class="courtsCard">
        <div class="sectionTitle big">Courts</div>
        <div id="courtList" class="list"></div>
      </div>

      <!-- Roster -->
      <div>
        <div class="sectionTitle">Roster</div>
        <div id="rosterList" class="list"></div>
      </div>
    </div>

    <!-- Fixed Partners -->
    <label style="margin-top:14px;">Fixed Partners</label>
    <div class="row">
      <select id="p1"></select>
      <select id="p2"></select>
      <button class="secondary" id="addPairBtn">Add Pair</button>
    </div>
    <div id="pairsBox" class="small"></div>

    <!-- Validation -->
    <label style="margin-top:14px;">Validation</label>
    <div class="small">
      <span id="selPlayersCount">0</span> players ·
      <span id="selCourtsCount">0</span> courts ·
      Need <strong id="requiredPlayers">0</strong> players
    </div>
    <div id="validationMsg" class="small"></div>

    <!-- Generate -->
    <div class="row" style="margin-top:14px;">
      <button id="generateBtn" class="primary" disabled>Generate Schedule</button>
      <button id="copyBtn" class="secondary">Copy Result</button>
    </div>
    <div id="status" class="small"></div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <div class="sectionTitle">Library</div>

    <label>Add Player</label>
    <div class="row">
      <input id="rosterAdd" type="text" placeholder="e.g., Nancy">
      <button id="rosterAddBtn" class="secondary">Add</button>
    </div>

    <label style="margin-top:12px;">Add Court</label>
    <div class="row">
      <input id="courtAdd" type="text" placeholder="e.g., CRT10">
      <button id="courtAddBtn" class="secondary">Add</button>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="rosterClearBtn" class="secondary">Clear Roster</button>
      <button id="courtClearBtn" class="secondary">Clear Courts</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Libraries are saved on this device (localStorage).
    </div>
  </div>
</div>

<!-- Output -->
<div class="card" style="margin-top:16px;">
  <div class="sectionTitle">Schedule</div>
  <div id="output" class="small">No schedule generated.</div>
</div>

<script>
/* =========================
   Time options: 08:30–21:00 every 30 min
========================= */
function buildTimeOptions(){
  const sel = document.getElementById("sessionTime");
  sel.innerHTML = "";
  let h = 8, m = 30;
  while (true){
    const hh = String(h).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    sel.innerHTML += `<option value="${hh}:${mm}">${hh}:${mm}</option>`;
    if (h === 21 && m === 0) break;
    m += 30;
    if (m >= 60){ m = 0; h += 1; }
  }
}

/* =========================
   Storage
========================= */
const LS_ROSTER = "playerhoods_roster_v4";
const LS_COURTS = "playerhoods_courts_v4";

const DEFAULT_ROSTER = [
  "Echo","Gillian","Jane","Lisa","Michele","Sandie","Sonia","Tao","Teng","Tina","Veronika","Nancy"
];
const DEFAULT_COURTS = ["CRT10","CRT11","CRT12","CRT13"];

let roster = [];
let courts = [];
let selectedPlayers = new Set();
let selectedCourts = new Set();
let fixedPairs = []; // [a,b]
let lastText = "";

function norm(s){ return (s||"").trim(); }
function escapeHtml(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function uniqCaseInsensitive(arr){
  const seen = new Set(), out = [];
  for (const x of arr){
    const v = norm(x);
    if (!v) continue;
    const k = v.toLowerCase();
    if (!seen.has(k)){ seen.add(k); out.push(v); }
  }
  return out;
}
function safeJsonParse(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
function saveAll(){
  try { localStorage.setItem(LS_ROSTER, JSON.stringify(roster)); } catch {}
  try { localStorage.setItem(LS_COURTS, JSON.stringify(courts)); } catch {}
}
function loadAll(){
  let rRaw=null,cRaw=null;
  try { rRaw = localStorage.getItem(LS_ROSTER); } catch {}
  try { cRaw = localStorage.getItem(LS_COURTS); } catch {}
  const rParsed = rRaw ? safeJsonParse(rRaw, null) : null;
  const cParsed = cRaw ? safeJsonParse(cRaw, null) : null;
  roster = Array.isArray(rParsed) ? uniqCaseInsensitive(rParsed) : DEFAULT_ROSTER.slice();
  courts = Array.isArray(cParsed) ? uniqCaseInsensitive(cParsed) : DEFAULT_COURTS.slice();
  roster.sort((a,b)=>a.localeCompare(b));
  courts.sort((a,b)=>a.localeCompare(b));
  saveAll();
}

function setStatus(msg, cls=""){
  const el = document.getElementById("status");
  el.className = "small " + (cls||"");
  el.textContent = msg || "";
}
function requiredPlayersCount(){ return selectedCourts.size * 4; }
function pairKey(a,b){ return [a,b].sort().join("||"); }
function groupKey4(arr4){ return arr4.slice().sort().join("||"); }

function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* =========================
   Render lists (no delete buttons)
========================= */
function renderRoster(){
  const box = document.getElementById("rosterList");
  box.innerHTML = roster.map(name=>{
    const checked = selectedPlayers.has(name) ? "checked" : "";
    return `
      <div class="item">
        <label class="checkboxRow">
          <input type="checkbox" data-name="${escapeHtml(name)}" ${checked}/>
          ${escapeHtml(name)}
        </label>
      </div>
    `;
  }).join("") || `<div class="small">No roster entries.</div>`;

  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change",(e)=>{
      const name = e.target.getAttribute("data-name");
      if (e.target.checked) selectedPlayers.add(name);
      else selectedPlayers.delete(name);
      onSelectionChanged();
    });
  });
}

function renderCourts(){
  const box = document.getElementById("courtList");
  box.innerHTML = courts.map(name=>{
    const checked = selectedCourts.has(name) ? "checked" : "";
    return `
      <div class="item">
        <label class="checkboxRow">
          <input type="checkbox" data-name="${escapeHtml(name)}" ${checked}/>
          ${escapeHtml(name)}
        </label>
      </div>
    `;
  }).join("") || `<div class="small">No court entries.</div>`;

  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change",(e)=>{
      const name = e.target.getAttribute("data-name");
      if (e.target.checked) selectedCourts.add(name);
      else selectedCourts.delete(name);
      onSelectionChanged();
    });
  });
}

/* =========================
   Fixed partners dropdowns
========================= */
function refreshPartnerDropdowns(){
  const p1 = document.getElementById("p1");
  const p2 = document.getElementById("p2");
  const players = Array.from(selectedPlayers).sort((a,b)=>a.localeCompare(b));
  const opts = ['<option value="">-- select --</option>']
    .concat(players.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`));
  p1.innerHTML = opts.join("");
  p2.innerHTML = opts.join("");
}

function validateFixedPairsAgainstSelection(){
  const set = new Set(selectedPlayers);
  fixedPairs = fixedPairs.filter(([a,b]) => set.has(a) && set.has(b));
}

function renderPairs(){
  const box = document.getElementById("pairsBox");
  if (fixedPairs.length === 0){
    box.innerHTML = "No fixed pairs.";
    return;
  }
  box.innerHTML = fixedPairs.map((p,i)=>`
    <div class="pairItem">
      <div><strong>${escapeHtml(p[0])}</strong> + <strong>${escapeHtml(p[1])}</strong></div>
      <button class="secondary" style="padding:6px 10px;" onclick="removePair(${i})">Remove</button>
    </div>
  `).join("");
}

window.removePair = function(i){
  fixedPairs.splice(i,1);
  renderPairs();
  setStatus("Fixed pair removed.", "ok");
};

function addPair(){
  const a = document.getElementById("p1").value;
  const b = document.getElementById("p2").value;
  if (!a || !b || a===b){ setStatus("Select two different players.", "warn"); return; }

  const used = new Set(fixedPairs.flat());
  if (used.has(a) || used.has(b)){
    alert("A player can only be in one fixed pair.");
    return;
  }
  fixedPairs.push([a,b]);
  renderPairs();
  setStatus(`Added fixed pair: ${a} + ${b}`, "ok");
}

/* =========================
   Validation
========================= */
function onSelectionChanged(){
  document.getElementById("selPlayersCount").textContent = selectedPlayers.size;
  document.getElementById("selCourtsCount").textContent = selectedCourts.size;
  const need = requiredPlayersCount();
  document.getElementById("requiredPlayers").textContent = need;

  refreshPartnerDropdowns();
  validateFixedPairsAgainstSelection();
  renderPairs();

  const msg = document.getElementById("validationMsg");
  const ok = selectedCourts.size > 0 && selectedPlayers.size === need;
  msg.innerHTML = ok ? `<span class="ok">Ready</span>` : `<span class="warn">Need exactly ${need} players for ${selectedCourts.size} courts</span>`;
  document.getElementById("generateBtn").disabled = !ok;
}

/* =========================
   Scheduling core (2 sets, Set2 optimized)
========================= */
function isFixedTeam(team){
  const k = pairKey(team[0], team[1]);
  return fixedPairs.some(([a,b]) => pairKey(a,b) === k);
}

function buildBlocks(players){
  const setPlayers = new Set(players);
  const blocks = [];
  const paired = new Set();
  for (const [a,b] of fixedPairs){
    if (setPlayers.has(a) && setPlayers.has(b)){
      blocks.push([a,b]);
      paired.add(a); paired.add(b);
    }
  }
  for (const p of players){
    if (!paired.has(p)) blocks.push([p]);
  }
  return shuffle(blocks);
}

function fillGroups(blocks, K){
  const groups = [];
  let cur = [];
  for (const blk of blocks){
    if (cur.length + blk.length > 4) return null;
    cur = cur.concat(blk);
    if (cur.length === 4){
      groups.push(cur);
      cur = [];
    }
  }
  if (cur.length !== 0) return null;
  if (groups.length !== K) return null;
  return groups;
}

function enforceFixedPairTeams(group4){
  for (const [a,b] of fixedPairs){
    if (group4.includes(a) && group4.includes(b)){
      const others = group4.filter(x => x !== a && x !== b);
      return [[a,b],[others[0],others[1]]];
    }
  }
  const g = shuffle(group4);
  return [[g[0],g[1]],[g[2],g[3]]];
}

function makeSet(players, courtsSelected){
  const K = courtsSelected.length;
  for (let tries=0; tries<350; tries++){
    const blocks = buildBlocks(players);
    const groups = fillGroups(blocks, K);
    if (!groups) continue;

    const matches = [];
    for (let i=0;i<K;i++){
      const group4 = groups[i];
      const teams = enforceFixedPairTeams(group4);
      matches.push({ court: courtsSelected[i], group: group4.slice(), A: teams[0], B: teams[1] });
    }
    return matches;
  }
  return null;
}

function deriveSetStats(setMatches){
  const groupKeys = new Set();
  const coOccur = new Set();
  const teammates = new Set();
  const opponents = new Set();
  for (const m of setMatches){
    const g = m.group.slice().sort();
    groupKeys.add(groupKey4(g));
    for (let i=0;i<g.length;i++){
      for (let j=i+1;j<g.length;j++){
        coOccur.add(pairKey(g[i],g[j]));
      }
    }
    teammates.add(pairKey(m.A[0],m.A[1]));
    teammates.add(pairKey(m.B[0],m.B[1]));
    for (const a of m.A){
      for (const b of m.B){
        opponents.add(pairKey(a,b));
      }
    }
  }
  return { groupKeys, coOccur, teammates, opponents };
}

function scoreSet2(candidate, set1Stats){
  const W_GROUP_REPEAT = 1000;
  const W_COOCUR = 6;
  const W_TEAM = 10;
  const W_OPP = 3;

  let penalty = 0;
  for (const m of candidate){
    const gk = groupKey4(m.group.slice().sort());
    if (set1Stats.groupKeys.has(gk)) penalty += W_GROUP_REPEAT;

    const g = m.group.slice().sort();
    for (let i=0;i<g.length;i++){
      for (let j=i+1;j<g.length;j++){
        if (set1Stats.coOccur.has(pairKey(g[i],g[j]))) penalty += W_COOCUR;
      }
    }

    const Ak = pairKey(m.A[0],m.A[1]);
    const Bk = pairKey(m.B[0],m.B[1]);
    if (!isFixedTeam(m.A) && set1Stats.teammates.has(Ak)) penalty += W_TEAM;
    if (!isFixedTeam(m.B) && set1Stats.teammates.has(Bk)) penalty += W_TEAM;

    for (const a of m.A){
      for (const b of m.B){
        const ok = pairKey(a,b);
        if (set1Stats.opponents.has(ok)) penalty += W_OPP;
      }
    }
  }
  return penalty;
}

function formatDatePretty(iso){
  if (!iso) return "(no date)";
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
}

function generateSchedule(){
  const courtsSelected = Array.from(selectedCourts).sort((a,b)=>a.localeCompare(b));
  const players = Array.from(selectedPlayers).sort((a,b)=>a.localeCompare(b));
  const need = courtsSelected.length * 4;

  if (courtsSelected.length === 0 || players.length !== need){
    setStatus("Selection invalid. Fix courts/players first.", "warn");
    return;
  }

  validateFixedPairsAgainstSelection();
  renderPairs();

  const set1 = makeSet(players, courtsSelected);
  if (!set1){
    setStatus("Failed to build Set 1. Try again.", "warn");
    return;
  }
  const stats1 = deriveSetStats(set1);

  let best = null;
  let bestScore = Infinity;
  for (let t=0;t<450;t++){
    const cand = makeSet(players, courtsSelected);
    if (!cand) continue;
    const s = scoreSet2(cand, stats1);
    if (s < bestScore){
      bestScore = s;
      best = cand;
      if (s === 0) break;
    }
  }
  const set2 = best || makeSet(players, courtsSelected);
  if (!set2){
    setStatus("Failed to build Set 2. Try again.", "warn");
    return;
  }

  const dateIso = document.getElementById("sessionDate").value;
  const time = document.getElementById("sessionTime").value;
  const datePretty = formatDatePretty(dateIso);

  function renderSet(setMatches, title){
    let html = `<h3 style="margin:14px 0 6px;">${title}</h3>`;
    html += `<table><tr><th>Court</th><th>Team A</th><th>Team B</th></tr>`;
    for (const m of setMatches){
      html += `<tr><td>${escapeHtml(m.court)}</td><td>${escapeHtml(m.A.join(" / "))}</td><td>${escapeHtml(m.B.join(" / "))}</td></tr>`;
    }
    html += `</table>`;
    return html;
  }

  const out = document.getElementById("output");
  out.innerHTML = `
    <div class="resultWrap">
      <div class="resultHeader">${escapeHtml(datePretty)} · ${escapeHtml(time)} · Courts: ${escapeHtml(courtsSelected.join(", "))}</div>
      <div class="subHeader">${players.length} players · 2 sets · doubles</div>
      ${renderSet(set1, "Set 1")}
      ${renderSet(set2, "Set 2")}
    </div>
  `;
  lastText = out.innerText;
  setStatus(`Generated. Set 2 penalty score: ${bestScore}`, "ok");
}

/* =========================
   Init + Events
========================= */
window.addEventListener("DOMContentLoaded", () => {
  buildTimeOptions();

  // default date = today
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  document.getElementById("sessionDate").value = `${yyyy}-${mm}-${dd}`;
  document.getElementById("sessionTime").value = "08:30";

  loadAll();
  renderRoster();
  renderCourts();
  refreshPartnerDropdowns();
  renderPairs();
  onSelectionChanged();

  document.getElementById("addPairBtn").addEventListener("click", addPair);
  document.getElementById("generateBtn").addEventListener("click", generateSchedule);

  document.getElementById("copyBtn").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(lastText || "");
      setStatus("Copied to clipboard.", "ok");
    } catch {
      setStatus("Copy failed (browser permission).", "warn");
    }
  });

  // Library add/clear
  document.getElementById("rosterAddBtn").addEventListener("click", () => {
    const v = norm(document.getElementById("rosterAdd").value);
    if (!v){ setStatus("Type a player name.", "warn"); return; }
    roster = uniqCaseInsensitive(roster.concat([v])).sort((a,b)=>a.localeCompare(b));
    document.getElementById("rosterAdd").value = "";
    saveAll();
    renderRoster();
    setStatus(`Added player: ${v}`, "ok");
  });

  document.getElementById("courtAddBtn").addEventListener("click", () => {
    const v = norm(document.getElementById("courtAdd").value);
    if (!v){ setStatus("Type a court label.", "warn"); return; }
    courts = uniqCaseInsensitive(courts.concat([v])).sort((a,b)=>a.localeCompare(b));
    document.getElementById("courtAdd").value = "";
    saveAll();
    renderCourts();
    setStatus(`Added court: ${v}`, "ok");
  });

  document.getElementById("rosterClearBtn").addEventListener("click", () => {
    if (!confirm("Clear roster library on this device?")) return;
    roster = [];
    selectedPlayers.clear();
    fixedPairs = [];
    saveAll();
    renderRoster();
    refreshPartnerDropdowns();
    renderPairs();
    onSelectionChanged();
    setStatus("Roster cleared.", "ok");
  });

  document.getElementById("courtClearBtn").addEventListener("click", () => {
    if (!confirm("Clear courts library on this device?")) return;
    courts = [];
    selectedCourts.clear();
    saveAll();
    renderCourts();
    onSelectionChanged();
    setStatus("Courts cleared.", "ok");
  });
});
</script>
</body>
</html>


